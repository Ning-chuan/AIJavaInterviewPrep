# 第 5 章：DDD 实践与落地

## 5.1 引言
   - 从理论到实践的桥梁
   - 成功落地 DDD 的关键因素

## 5.2 代码组织结构
   - **5.2.1 按层组织 vs 按特性/领域组织**
     - 传统分层架构的代码组织方式
     - DDD 中推荐的按领域模块或限界上下文组织代码
       - 例如：`com.company.project.ordermanagement` (订单上下文)
         - `application` (应用服务, DTOs)
         - `domain` (聚合, 实体, 值对象, 领域服务, 领域事件, 资源库接口)
         - `infrastructure` (资源库实现, 外部服务适配器)
         - `interfaces` (API控制器, 事件监听器等)
   - **5.2.2 模块化设计**
     - Java 中的模块化 (Maven/Gradle modules, Java Platform Module System)

## 5.3 DDD 在微服务架构中的应用
   - **5.3.1 限界上下文作为微服务划分的依据**
     - 一个限界上下文通常可以映射为一个或多个微服务。
     - 考虑服务的自治性、内聚性和业务能力。
   - **5.3.2 微服务间的通信与集成**
     - 同步 vs 异步通信
     - 事件驱动架构 (EDA) 与领域事件
     - API 网关与 BFF (Backend For Frontend)
   - **5.3.3 跨微服务的事务与数据一致性**
     - Saga 模式
     - 最终一致性

## 5.4 事件风暴 (Event Storming)
   - **5.4.1 什么是事件风暴？**
     - 一种基于工作坊的协作方法，用于快速探索复杂业务领域。
     - 由 Alberto Brandolini 提出。
   - **5.4.2 如何进行事件风暴？**
     - 参与者：领域专家、开发人员、测试人员、产品经理等。
     - 工具：大量彩色即时贴、大白板或墙壁。
     - 流程：
       1. **识别领域事件 (Domain Events)**：用橙色便签，写下业务流程中发生的重要事情（过去时态）。
       2. **识别命令 (Commands)**：用蓝色便签，触发事件的动作或用户操作。
       3. **识别执行者 (Actors/Users)**：用黄色小人便签，执行命令的角色。
       4. **识别聚合 (Aggregates)**：用黄色大便签，处理命令并产生事件的业务对象（通常是名词）。
       5. **识别读模型/视图 (Read Models/Views)**：用绿色便签，用户决策所需的信息。
       6. **识别外部系统 (External Systems)**：用粉色便签，与本系统交互的外部依赖。
       7. **识别策略/规则 (Policies)**：在事件和命令之间，用紫色便签，描述业务规则或决策逻辑。
       8. **划分限界上下文和子域**：根据事件流和业务关联性进行初步划分。
   - **5.4.3 事件风暴的价值**
     - 快速建立共享理解（通用语言）。
     - 识别核心领域和业务流程。
     - 辅助限界上下文的划分。
     - 发现潜在的业务规则和复杂性。

## 5.5 如何从现有系统重构到 DDD
   - **5.5.1 绞杀者模式 (Strangler Fig Pattern)**
     - 逐步用新系统替换旧系统的功能，新旧系统并存一段时间。
   - **5.5.2 识别核心域，从核心域开始**
   - **5.5.3 引入防腐层保护新模型**
   - **5.5.4 逐步提取领域服务和聚合**
   - **5.5.5 团队学习与能力建设**

## 5.6 DDD 面临的挑战与反模式
   - **5.6.1 常见挑战**
     - 学习曲线陡峭，需要团队转变思维模式。
     - 需要领域专家的深度参与和良好沟通。
     - 过度设计或过早优化。
     - 难以正确划分限界上下文和聚合。
     - 基础设施的复杂性（如在CQRS, ES场景下）。
   - **5.6.2 常见反模式**
     - **贫血领域模型 (Anemic Domain Model)**：领域对象只有 getter/setter，没有业务逻辑。
     - **事务脚本 (Transaction Script) 伪装的领域服务**：领域服务包含大量过程式代码，而不是协调领域对象。
     - **大泥球 (Big Ball of Mud)**：缺乏清晰的边界和结构。
     - **上帝类/上帝聚合 (God Class/Aggregate)**：少数类或聚合承担了过多的职责。
     - **滥用值对象或实体**。
     - **忽略通用语言的建设**。

## 5.7 本章小结 
# 第2章：MySQL存储引擎

## 2.1 存储引擎概述

### 存储引擎的定义与作用
存储引擎是MySQL的核心组件，负责数据的存储、管理和操作。它们定义了数据在磁盘上的组织方式、记录的存取方式以及索引的实现方法。不同的存储引擎提供不同的存储机制、索引技巧、锁定水平等功能，使用不同的存储引擎，可以获得特定的功能。

### MySQL支持的主要存储引擎
MySQL 5.7及以上版本支持的主要存储引擎包括：
- **InnoDB**：默认的事务型存储引擎，支持ACID、行级锁和外键
- **MyISAM**：早期默认的存储引擎，不支持事务，支持表级锁
- **Memory**：内存存储引擎，数据存储在内存中，重启后数据丢失
- **Archive**：归档存储引擎，用于数据归档，只支持插入和查询操作
- **Blackhole**：黑洞存储引擎，写入的数据会被丢弃
- **CSV**：以CSV格式存储数据的引擎
- **Federated**：允许访问远程MySQL服务器上的表
- **Merge**：允许将多个MyISAM表合并成一个虚拟表

可以通过以下命令查看MySQL支持的存储引擎：
```sql
SHOW ENGINES;
```

### 如何选择合适的存储引擎

选择存储引擎应考虑以下因素：
1. **事务支持**：是否需要ACID特性
2. **并发性能**：需要什么级别的锁（行锁/表锁）
3. **外键约束**：是否需要参照完整性
4. **备份恢复**：热备份能力和恢复速度
5. **崩溃恢复**：系统崩溃后的数据恢复能力
6. **特殊需求**：如全文检索、内存存储等

一般建议：
- 需要事务支持、外键、高并发读写 → InnoDB
- 只读或以读为主的应用 → MyISAM
- 临时数据、高速访问 → Memory
- 日志、数据归档 → Archive

## 2.2 InnoDB存储引擎

### InnoDB体系结构
InnoDB是一个具有完整事务特性的存储引擎，其架构可分为内存架构和磁盘架构两部分。

![InnoDB架构图]

### 内存结构

#### 缓冲池（Buffer Pool）
缓冲池是InnoDB最重要的内存结构，用于缓存表数据和索引数据。通过缓冲池，InnoDB可以将读取操作变为内存操作，大大提高读取效率。同时，对数据的修改也先在缓冲池中进行，然后以一定频率刷新到磁盘，提高写入效率。

缓冲池采用LRU（最近最少使用）算法管理，但InnoDB对传统LRU算法进行了优化：
- 将LRU列表分为新生代（young）和老生代（old）两部分
- 新读取的页不直接放入新生代头部，而是放入老生代头部
- 只有在老生代停留超过一定时间（默认1秒）的页才会被移到新生代

这种设计有效防止了预读失效和全表扫描带来的缓冲池污染问题。

#### 重做日志缓冲（Redo Log Buffer）
重做日志缓冲存储即将写入重做日志文件的数据，默认大小为16MB。在以下三种情况下，重做日志缓冲会被刷新到磁盘：
1. Master线程每秒执行刷新
2. 每个事务提交时
3. 当重做日志缓冲池剩余空间小于1/2时

#### 变更缓冲区（Change Buffer）
变更缓冲区是一种特殊的数据结构，用于缓存对非唯一二级索引页的操作。当需要修改的索引页不在内存中时，InnoDB会将修改操作缓存到Change Buffer中，以此减少磁盘IO。后续在访问相关页或系统较空闲时，这些缓存的修改会被合并到实际的索引页中（Change Buffer Merge）。

#### 自适应哈希索引（Adaptive Hash Index）
InnoDB会监控对表索引的查询，如果发现某些模式的查询十分频繁，会在内存中基于B+树索引之上创建哈希索引，提高查询效率。自适应哈希索引是完全自动的，用户无法直接控制其创建过程，但可以通过参数`innodb_adaptive_hash_index`来开启或关闭。

### 磁盘结构

#### 系统表空间（System Tablespace）
系统表空间是InnoDB最初的表空间类型，包含InnoDB数据字典、双写缓冲区（Doublewrite Buffer）、变更缓冲区（Change Buffer）和undo日志等。在MySQL 5.5之前，所有InnoDB表都存储在系统表空间中。默认文件名为ibdata1。

#### 独立表空间（File-Per-Table Tablespaces）
从MySQL 5.6开始，默认启用`innodb_file_per_table`参数，为每张表创建独立的表空间文件（.ibd文件）。这种方式有以下优势：
- 表空间文件删除时可以直接回收磁盘空间
- 可以单独对表进行备份和恢复
- 避免系统表空间过大
- 减少表之间的IO争用

#### 通用表空间（General Tablespaces）
通用表空间是MySQL 5.7引入的共享表空间，可以存储多个表的数据，并支持所有InnoDB表功能。通过CREATE TABLESPACE语句创建：
```sql
CREATE TABLESPACE ts_name ADD DATAFILE 'file_name' ENGINE=InnoDB;
```

#### 撤销表空间（Undo Tablespaces）
存储undo日志的表空间。undo日志用于事务回滚和MVCC。从MySQL 8.0开始，undo日志默认存储在独立的undo表空间中，而不是系统表空间。

#### 临时表空间（Temporary Tablespaces）
存储用户创建的临时表和临时查询结果的表空间。

#### 双写缓冲（Doublewrite Buffer）
为解决部分页写入问题（partial page write），InnoDB使用双写缓冲机制：
1. 将缓冲池中的脏页先复制到双写缓冲
2. 将双写缓冲内容写入系统表空间中的双写缓冲区域
3. 将脏页写入数据文件

这样即使在写入数据文件过程中系统崩溃，也可以从双写缓冲中恢复完整的页。

#### 重做日志（Redo Log）
用于记录对InnoDB存储引擎的事务操作，保证事务的持久性和数据库的一致性。InnoDB通过预写日志（WAL，Write-Ahead Logging）技术实现崩溃恢复：所有修改在应用到数据文件之前，必须先写入到重做日志。

重做日志文件通常有两个，循环使用，减少日志切换的开销。默认大小为48MB。

### InnoDB的MVCC实现机制

MVCC（多版本并发控制）是InnoDB实现高并发的核心技术，通过保存数据的多个版本，让读写操作互不阻塞，提高并发性能。

InnoDB的MVCC主要通过以下方式实现：

1. **隐藏字段**：每行数据中包含两个隐藏列
   - `DB_TRX_ID`：最后一次插入或更新该行的事务ID
   - `DB_ROLL_PTR`：回滚指针，指向undo日志中该行的前一个版本
   
2. **ReadView机制**：在读已提交和可重复读隔离级别下，InnoDB通过ReadView判断当前事务能够看到哪个版本的数据。ReadView包含以下信息：
   - `m_ids`：生成ReadView时，当前系统中活跃的事务ID列表
   - `min_trx_id`：活跃事务列表中最小的事务ID
   - `max_trx_id`：系统分配给下一个事务的ID
   - `creator_trx_id`：创建ReadView的事务ID

3. **版本可见性判断**：对于一行记录，判断其版本是否可见的规则如下：
   - 如果记录的`DB_TRX_ID` < `min_trx_id`，说明该版本的事务在当前事务创建ReadView前已提交，该版本可见
   - 如果记录的`DB_TRX_ID` >= `max_trx_id`，说明该版本的事务在当前事务创建ReadView后才开始，该版本不可见
   - 如果`min_trx_id` <= 记录的`DB_TRX_ID` < `max_trx_id`，则需要判断`DB_TRX_ID`是否在`m_ids`列表中，如果在，说明该版本的事务在当前事务创建ReadView时还活跃，该版本不可见；否则，该版本可见

4. **读已提交和可重复读的区别**：
   - 在读已提交隔离级别下，每次读取数据时都会创建新的ReadView
   - 在可重复读隔离级别下，只在第一次读取数据时创建ReadView，之后一直沿用这个ReadView

## 2.3 MyISAM存储引擎

### MyISAM体系结构
MyISAM是MySQL 5.5之前的默认存储引擎，不支持事务、外键和行级锁，但具有较高的查询性能和较低的存储开销。

MyISAM表对应三个文件：
- `.frm`：表结构定义文件（MySQL 8.0后移至系统表中）
- `.MYD`：数据文件（MYData）
- `.MYI`：索引文件（MYIndex）

### 索引实现与特点

1. **B+树索引结构**：MyISAM使用B+树作为索引结构，但与InnoDB的实现略有不同：
   - 索引文件和数据文件是分离的
   - 索引记录中存储的是数据文件的物理地址
   - 叶子节点只包含键值和指向数据记录的指针

2. **索引类型**：
   - **非聚集索引**：MyISAM的所有索引都是非聚集索引，主键索引与其他索引在结构上无区别
   - **压缩索引**：MyISAM支持索引压缩，可以显著减小索引空间
   - **全文索引**：原生支持全文索引，适用于全文检索场景

3. **索引特性**：
   - **前缀压缩**：MyISAM的索引支持前缀压缩，对于字符串类型的索引列，相同前缀只会存储一次
   - **延迟索引更新**：批量插入数据时，可以延迟索引的更新，提高插入性能

### 与InnoDB的对比分析

| 特性 | MyISAM | InnoDB |
|------|-------|--------|
| 事务支持 | 不支持 | 支持 |
| 锁机制 | 表级锁 | 行级锁 |
| 外键约束 | 不支持 | 支持 |
| MVCC | 不支持 | 支持 |
| 崩溃恢复 | 较弱 | 强大 |
| 存储空间 | 较小 | 较大 |
| 读取性能 | 快（尤其是全表扫描） | 较快 |
| 写入性能 | 在大量并发下较慢 | 在大量并发下较快 |
| 全文索引 | 支持（MySQL 5.6之前仅MyISAM支持） | 支持（MySQL 5.6+） |
| 适用场景 | 读密集型应用 | 读写混合型应用 |

### 适用场景

MyISAM适合以下场景：
1. **读密集型应用**：查询为主，很少更新的应用
2. **低并发系统**：由于表锁的限制，不适合高并发写入场景
3. **全文检索**：MySQL 5.6之前，只有MyISAM支持全文索引
4. **空间数据存储**：MySQL 5.7之前，空间数据索引只支持MyISAM
5. **临时表**：MySQL的内部临时表在Memory容量不够时会转为MyISAM

## 2.4 其他存储引擎

### Memory存储引擎
Memory引擎将表数据存储在内存中，具有极高的读写性能，但数据库重启后数据会丢失。

**主要特点**：
- 表数据存储在内存中，访问速度极快
- 默认使用哈希索引，也支持B+树索引
- 只支持表级锁，并发写入性能较低
- 不支持BLOB和TEXT类型的列
- 支持的数据类型和功能有限
- 表级别的内存限制受系统变量 `max_heap_table_size` 控制

**适用场景**：
- 用作临时表或缓存表
- 需要快速访问且数据量较小的查找表
- 数据丢失不会造成严重后果的场景

**使用示例**：
```sql
CREATE TABLE temp_table (
    id INT PRIMARY KEY,
    name VARCHAR(100)
) ENGINE=MEMORY;
```

### Archive存储引擎
Archive引擎专门用于数据归档，支持高效的插入和压缩存储。

**主要特点**：
- 只支持INSERT和SELECT操作，不支持UPDATE和DELETE
- 使用行级锁和zlib压缩算法
- 不支持索引（MySQL 5.1之后支持索引）
- 存储空间占用小，适合存储大量的历史数据
- 数据压缩比例通常可达1:10

**适用场景**：
- 日志和审计数据归档
- 历史数据存储
- 需要节省存储空间且主要以插入和查询为主的应用

### Blackhole存储引擎
Blackhole引擎会丢弃所有写入的数据，但会记录二进制日志。

**主要特点**：
- 接收但不存储数据，写入操作会被忽略
- 查询永远返回空结果集
- 会记录二进制日志（如果启用）

**适用场景**：
- 分布式环境中的日志传输
- 性能测试
- 数据复制架构中的中继服务器

### CSV存储引擎
CSV引擎将数据以逗号分隔值格式存储在文本文件中。

**主要特点**：
- 以CSV格式存储数据，便于与其他应用程序交换数据
- 不支持索引
- 表结构存储在.frm文件中，数据存储在.CSV文件中
- 可以直接编辑CSV文件，MySQL会自动识别变化

**适用场景**：
- 需要与其他应用程序共享数据的场景
- 数据导入导出
- 简单的数据交换需求

## 2.5 常见面试题

### InnoDB和MyISAM有哪些区别？各自适用于什么场景？

**区别**：
1. **事务支持**：InnoDB支持事务，而MyISAM不支持
2. **锁机制**：InnoDB支持行级锁，MyISAM只支持表级锁
3. **外键**：InnoDB支持外键约束，MyISAM不支持
4. **崩溃恢复**：InnoDB有崩溃恢复能力（通过redo log），MyISAM崩溃后可能导致数据损坏
5. **存储结构**：
   - InnoDB：数据和索引存储在一起（聚集索引）
   - MyISAM：数据和索引分开存储（非聚集索引）
6. **MVCC**：InnoDB支持MVCC，实现了非锁定读，MyISAM不支持
7. **全文索引**：MySQL 5.6之前只有MyISAM支持全文索引，5.6之后InnoDB也支持
8. **存储限制**：MyISAM单表大小限制为256TB，InnoDB受制于操作系统文件大小限制

**适用场景**：
- **InnoDB**：
  - 需要事务支持的应用
  - 高并发写入的应用
  - 需要外键约束的场景
  - 需要崩溃安全恢复的重要数据
  
- **MyISAM**：
  - 只读或以读为主的应用
  - 对事务完整性要求不高的应用
  - 全文检索（MySQL 5.6之前）
  - 空间数据存储（MySQL 5.7之前）

### 为什么InnoDB成为MySQL的默认存储引擎？

InnoDB在MySQL 5.5版本中取代MyISAM成为默认存储引擎，主要原因包括：

1. **事务支持**：InnoDB提供完整的ACID事务支持，满足企业级应用需求
2. **并发处理能力**：通过MVCC和行级锁，InnoDB在高并发环境下性能远优于MyISAM
3. **数据安全性**：InnoDB的崩溃恢复机制更加可靠，能有效防止数据丢失
4. **外键支持**：InnoDB支持外键约束，保证数据完整性
5. **扩展性**：随着CPU多核和大内存服务器的普及，InnoDB的性能优势更加明显
6. **行业趋势**：随着Web应用和OLTP系统的普及，对事务性存储引擎的需求增加
7. **技术优势**：Oracle收购MySQL后，加大了对InnoDB的开发投入

### InnoDB的MVCC是如何实现的？

InnoDB的MVCC（多版本并发控制）主要通过以下机制实现：

1. **版本链**：每个记录都维护一个版本链
   - 每行数据包含隐藏字段`DB_TRX_ID`（事务ID）和`DB_ROLL_PTR`（回滚指针）
   - 每次更新操作，都会生成一个新版本并通过回滚指针链接到旧版本
   - 旧版本保存在undo log中
   
2. **ReadView**：事务开始时创建，用于判断记录版本可见性
   - `m_ids`：活跃事务ID列表
   - `min_trx_id`：活跃事务中最小的事务ID
   - `max_trx_id`：下一个将被分配的事务ID
   - `creator_trx_id`：创建该ReadView的事务ID
   
3. **版本可见性判断**：
   - 如果记录的`DB_TRX_ID` < `min_trx_id`，则可见
   - 如果记录的`DB_TRX_ID` >= `max_trx_id`，则不可见
   - 如果`min_trx_id` <= 记录的`DB_TRX_ID` < `max_trx_id`，则需判断`DB_TRX_ID`是否在`m_ids`中，在则不可见，不在则可见
   
4. **隔离级别和ReadView创建时机**：
   - 读已提交：每次读取数据时创建新的ReadView
   - 可重复读：事务开始时创建ReadView，并在整个事务过程中使用同一个ReadView

### 如何查看当前MySQL支持哪些存储引擎？如何修改表的存储引擎？

**查看支持的存储引擎**：
```sql
SHOW ENGINES;
```

**查看默认存储引擎**：
```sql
SHOW VARIABLES LIKE 'default_storage_engine';
```

**查看特定表的存储引擎**：
```sql
SHOW TABLE STATUS LIKE 'table_name';
```
或
```sql
SHOW CREATE TABLE table_name;
```

**修改表的存储引擎**：
```sql
ALTER TABLE table_name ENGINE = engine_name;
```
例如，将mytable从MyISAM转换为InnoDB：
```sql
ALTER TABLE mytable ENGINE = InnoDB;
```

**创建表时指定存储引擎**：
```sql
CREATE TABLE table_name (
  /* 列定义 */
) ENGINE = engine_name;
```

**修改默认存储引擎**：
在MySQL配置文件中修改`default-storage-engine`参数，或使用以下命令修改当前会话的默认存储引擎：
```sql
SET default_storage_engine = engine_name;
```

## 本章要点

- **存储引擎选择**：理解各存储引擎的特点和适用场景，是数据库设计的重要决策
- **InnoDB核心机制**：
  - 事务实现（redo log、undo log）
  - 并发控制（MVCC、锁机制）
  - 存储结构（表空间、页结构）
  - 内存管理（缓冲池、LRU算法）
- **MyISAM与InnoDB对比**：理解两种引擎在性能、功能和应用场景上的差异
- **性能调优基础**：
  - 正确配置InnoDB缓冲池大小
  - 理解并合理设置redo log和undo log相关参数
  - 掌握双写缓冲、变更缓冲等优化机制

深入理解MySQL存储引擎的工作原理，不仅是应对面试的基础，也是数据库性能调优和故障排查的前提。掌握InnoDB的内部机制，才能更好地优化SQL查询，设计高效的数据库结构，解决实际工作中遇到的数据库问题。 
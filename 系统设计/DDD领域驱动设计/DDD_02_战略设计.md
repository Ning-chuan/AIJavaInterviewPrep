# 第2章：战略设计（Strategic Design）

战略设计是DDD的核心环节，它关注的是如何在复杂业务中划分系统边界、识别领域模型，并确保不同模型之间的协作。战略设计的目标是帮助团队在宏观层面理解业务领域的结构，找出核心业务，并进行合理的系统边界划分。

## 2.1 限界上下文（Bounded Context）

### 2.1.1 概念与作用
限界上下文是一个显式的边界，在这个边界内，领域模型的术语、概念和规则保持一致和精确。它是模型完整性的边界，也是团队工作的边界。

**为什么需要限界上下文？**
- **解决概念冲突**：同一个词在不同上下文中可能有不同含义（例如，电商系统中的"商品"在销售、库存、物流中含义不同）
- **降低复杂性**：将大系统划分为多个相对独立的小系统
- **实现模型的一致性和精确性**：确保在特定边界内的术语和规则统一

### 2.1.2 识别限界上下文的方法与技巧
- **基于业务能力**：分析业务核心能力和职责
- **基于语言变化**：当术语开始有不同含义时，可能需要新的上下文
- **基于团队结构**：康威定律表明，系统设计往往反映组织结构
- **基于变更频率**：变更频率不同的部分可能属于不同上下文

**识别技巧**：
1. 关注语言差异和歧义
2. 注意业务流程的自然边界
3. 分析数据的生命周期和所有权
4. 考虑系统与外部系统的集成点

### 2.1.3 如何划分合理的限界上下文
- **业务能力划分**：根据业务能力和职责划分（如订单管理、库存管理）
- **团队结构划分**：一个团队负责一个或多个上下文
- **变更频率**：变更频率相似的组件可以放在同一上下文
- **数据一致性需求**：强一致性需求的实体应在同一上下文

**划分原则**：
- 保持上下文大小适中：既不过大导致复杂度无法管理，也不过小导致过度碎片化
- 确保领域专家能够在上下文中使用一致的语言
- 考虑技术实现的复杂性和可行性

### 2.1.4 限界上下文与微服务的关系
- 限界上下文是微服务的理论基础：每个微服务通常对应一个或多个限界上下文
- 不是一一对应关系：有时一个上下文可能分为多个微服务，或多个小上下文合并为一个微服务
- 微服务边界定义的核心考量：业务自治性、团队自治性、技术异构性

**最佳实践**：
- 先识别限界上下文，再考虑微服务划分
- 微服务边界应该遵循DDD的限界上下文，但也需考虑性能、部署和团队因素
- 防止过度拆分：微服务数量应与组织能力相匹配

## 2.2 上下文映射（Context Mapping）

上下文映射定义了不同限界上下文之间的关系和集成方式，它帮助团队理解系统边界以及跨界协作方式。

### 2.2.1 上下文之间的关系模式

#### 合作关系（Partnership）
- **定义**：两个团队建立密切合作关系，共同定义集成方式
- **特点**：双方相互依赖，共同规划和调整各自系统
- **应用场景**：两个紧密关联且同等重要的业务领域
- **示例**：订单管理和支付处理系统紧密协作，共同确保交易完整性

#### 共享内核（Shared Kernel）
- **定义**：多个上下文共享部分领域模型
- **特点**：共享部分变更需要多方协调，变更成本高
- **应用场景**：多个子系统需共享关键概念时
- **实现方式**：共享库、共享数据库架构
- **优缺点**：减少重复但增加耦合，应谨慎使用

#### 客户-供应商（Customer-Supplier）
- **定义**：上游（供应商）向下游（客户）提供服务
- **特点**：上游考虑下游需求，但保留决策权
- **场景**：一个系统依赖另一个系统提供的数据或功能
- **示例**：商品目录系统（供应商）向订单系统（客户）提供商品信息

#### 跟随者（Conformist）
- **定义**：下游系统完全接受上游系统的模型，无协商能力
- **场景**：与难以影响的外部系统或遗留系统集成
- **特点**：简化集成，但可能导致下游模型不够理想
- **示例**：与第三方支付平台集成，必须按照其API规范

#### 防腐层（Anticorruption Layer）
- **定义**：在系统边界建立翻译层，隔离外部模型
- **作用**：保护本系统领域模型免受外部模型污染
- **实现方式**：适配器、门面模式、转换器
- **适用场景**：与遗留系统、第三方系统集成，且模型差异大
- **代码示例**：
```java
// 外部系统DTO
class LegacyCustomerDTO {
    private String customerNum;
    private String customerName;
    // ...
}

// 我们的领域模型
class Customer {
    private CustomerId id;
    private Name name;
    // ...
}

// 防腐层
class CustomerAntiCorruptionLayer {
    // 转换逻辑
    public Customer translate(LegacyCustomerDTO dto) {
        return new Customer(
            new CustomerId(dto.getCustomerNum()),
            new Name(dto.getCustomerName())
        );
    }
}
```

#### 开放主机服务（Open Host Service）
- **定义**：系统通过一组明确定义的服务协议与外部交互
- **特点**：提供稳定的公共API，隐藏内部细节
- **场景**：作为平台向多个消费者提供服务
- **实现**：REST API、GraphQL、RPC等

#### 发布语言（Published Language）
- **定义**：系统间交互的标准化数据格式
- **特点**：明确定义，减少误解
- **实现方式**：XML Schema、JSON Schema、Protocol Buffers
- **与开放主机服务配合**：定义接口的数据结构

#### 各自为政（Separate Ways）
- **定义**：不同团队独立实现相似功能，避免集成
- **应用**：当集成成本超过重复实现成本
- **优势**：完全自治，避免外部依赖
- **权衡**：可能导致功能重复

#### 大泥球（Big Ball of Mud）
- **定义**：缺乏清晰边界的混乱系统
- **特点**：概念混杂，边界模糊
- **处理策略**：识别问题区域，逐步重构和边界划分

### 2.2.2 如何选择合适的上下文映射模式
- **考量因素**：
  - 团队关系和影响力
  - 技术限制和遗留系统情况
  - 业务变化频率
  - 集成复杂度
  - 组织政治因素

- **决策流程**：
  1. 分析上下文关系的性质（依赖方向、影响力）
  2. 评估各种集成方式的成本和收益
  3. 考虑团队协作模式和组织因素
  4. 选择最适合当前情况的模式，并随时间演进

### 2.2.3 上下文映射图的绘制与应用
- **作用**：可视化系统间关系，帮助沟通和决策
- **绘制方法**：使用简单图形表示各上下文及关系类型
- **工具推荐**：Draw.io、Miro、Context Mapper等
- **实践建议**：
  - 定期回顾和更新
  - 将图纳入项目文档
  - 用于团队讨论和新成员培训

## 2.3 领域语言（Ubiquitous Language）

领域语言是DDD的核心理念，指的是团队成员（包括技术人员和领域专家）共同使用的语言，它直接反映在代码、文档和日常交流中。

### 2.3.1 统一语言的构建方法
- **从业务专家开始**：捕获领域专家使用的术语和概念
- **建立术语表**：记录关键术语及其定义
- **持续精炼**：通过讨论和实践不断完善语言
- **消除歧义**：确保每个术语在上下文中有明确含义
- **代码即文档**：代码结构应反映领域语言

**实践步骤**：
1. 组织领域专家和开发人员的研讨会
2. 记录关键术语和概念
3. 在不同场景下验证术语一致性
4. 创建术语表并持续维护
5. 确保代码中的命名与领域语言一致

### 2.3.2 事件风暴（Event Storming）工作坊
- **概念**：通过识别领域事件来探索业务流程
- **目标**：快速建立领域模型和统一语言
- **参与者**：领域专家、产品经理、架构师、开发人员
- **流程**：
  1. 识别领域事件（橙色便签）
  2. 添加触发命令（蓝色便签）
  3. 识别聚合根/决策者（黄色便签）
  4. 确定策略和业务规则（紫色便签）
  5. 划分上下文边界

### 2.3.3 语言模型与代码模型的一致性
- **命名一致性**：代码中的类、方法、变量命名应反映领域概念
- **结构一致性**：代码结构应反映领域关系
- **行为一致性**：业务规则应直接映射到代码逻辑

**示例**：
```java
// 不良实践：技术导向的命名
class CustomerManager {
    public void process(CustomerData data) { ... }
}

// 良好实践：反映领域语言
class CustomerRegistration {
    public void registerNewCustomer(Customer customer) { ... }
}
```

### 2.3.4 领域专家与开发团队的协作方式
- **持续参与**：领域专家定期参与开发讨论
- **结对探索**：开发人员与领域专家结对工作
- **示例驱动**：通过具体业务场景讨论
- **可视化工具**：使用图表、原型展示理解
- **反馈循环**：定期展示和验证实现

**最佳实践**：
- 避免技术术语污染业务讨论
- 创建轻量级文档记录关键决策
- 使用实例和场景澄清抽象概念
- 定期回顾并完善统一语言

## 2.4 战略设计的工具与实践

### 2.4.1 事件风暴（Event Storming）
- **详细步骤**：
  1. **准备**：大型白板/墙面、不同颜色便签、记号笔
  2. **识别领域事件**：从"已发生的事实"开始（橙色便签）
  3. **时间线排序**：按时间顺序排列事件
  4. **添加触发命令**：识别触发每个事件的命令（蓝色便签）
  5. **确定角色**：哪些角色执行这些命令（黄色便签）
  6. **识别聚合**：哪些实体/聚合接受命令并产生事件
  7. **添加读模型**：用户决策所需信息（绿色便签）
  8. **识别热点和痛点**：标记复杂或问题区域（红色便签）
  9. **划分上下文**：确定模型边界

- **成功要素**：
  - 合适的参与者（领域专家必不可少）
  - 开放的讨论氛围
  - 专注于业务流程而非技术实现
  - 适当的引导和时间控制

### 2.4.2 影响地图（Impact Mapping）
- **目的**：连接业务目标与具体实施
- **结构**：
  - **为什么**：业务目标
  - **谁**：关键利益相关者
  - **如何**：利益相关者行为改变
  - **什么**：需要开发的功能/解决方案
- **应用**：
  - 确保开发工作与业务价值对齐
  - 识别优先级和MVP范围
  - 可视化战略决策

### 2.4.3 用户故事地图（User Story Mapping）
- **概念**：二维视图展示用户旅程和系统功能
- **结构**：
  - 横轴：用户活动/步骤（时间顺序）
  - 纵轴：每个活动的具体任务（优先级顺序）
- **价值**：
  - 全局视角理解用户体验
  - 识别MVP和后续迭代范围
  - 帮助团队理解功能间关系

### 2.4.4 领域讲故事（Domain Storytelling）
- **方法**：通过图形化符号讲述领域专家如何完成工作
- **元素**：
  - 角色（人或系统）
  - 工作对象
  - 活动（编号序列）
- **流程**：
  1. 领域专家讲述工作故事
  2. 主持人使用图形记录
  3. 团队讨论和完善模型
  4. 识别领域概念和流程
- **优势**：简单直观，降低沟通障碍

## 2.5 战略设计在企业架构中的应用

### 2.5.1 企业架构视角下的DDD
- **企业架构关注点**：
  - 业务架构
  - 信息架构
  - 应用架构
  - 技术架构
- **DDD在企业架构中的作用**：
  - 连接业务战略与IT实现
  - 提供划分系统边界的方法
  - 促进业务与IT协作

### 2.5.2 领域与子域划分
- **核心域（Core Domain）**：
  - 业务核心竞争力所在
  - 需要最多投入和创新
  - 通常不适合外包或使用通用解决方案
  - 例如：电商平台的推荐系统、金融机构的风控系统

- **支撑域（Supporting Domain）**：
  - 支持核心业务但不是差异化因素
  - 可能需要定制开发但优先级低于核心域
  - 例如：客户管理系统、报表系统

- **通用域（Generic Domain）**：
  - 各公司通用的标准功能
  - 可考虑购买现成产品或外包开发
  - 例如：人力资源管理、财务记账系统

- **子域识别方法**：
  - 分析业务能力图谱
  - 评估各功能对业务的战略价值
  - 考虑技术复杂度和创新需求

### 2.5.3 组织结构与限界上下文的对齐
- **康威定律影响**：系统设计反映组织沟通结构
- **团队自治与边界**：团队边界应与上下文边界一致
- **组织结构演进**：随着领域理解深入，组织可能需要调整
- **最佳实践**：
  - 围绕业务能力组织团队
  - 赋予团队端到端责任
  - 减少跨团队依赖

## 2.6 面试要点

### 2.6.1 限界上下文的识别方法与实例
- **面试问题**：如何在一个电商系统中识别限界上下文？
- **回答要点**：
  - 分析主要业务流程（下单、支付、物流等）
  - 识别语言差异（同一术语在不同场景下的含义）
  - 考虑数据一致性需求
  - 分析变更频率和团队结构
- **具体示例**：
  - 商品上下文：管理商品信息、分类、定价
  - 订单上下文：处理订单创建、状态变更
  - 库存上下文：管理库存数量、预留、调拨
  - 支付上下文：处理支付方式、交易记录
  - 会员上下文：管理用户信息、等级、积分

### 2.6.2 防腐层的设计与实现方式
- **面试问题**：什么情况下需要防腐层？如何实现？
- **回答要点**：
  - 需要场景：与遗留系统、第三方系统集成，模型差异大
  - 实现模式：适配器模式、门面模式、转换器
  - 设计原则：封装外部系统细节，提供领域友好接口
- **代码示例讲解**：
  - 服务适配器：转换API调用
  - 数据转换：外部DTO与内部领域对象转换
  - 接口隔离：定义明确的集成点

### 2.6.3 如何在团队中推广统一语言
- **面试问题**：作为架构师，如何推动团队采用统一语言？
- **回答要点**：
  - 组织领域建模工作坊，邀请业务专家参与
  - 创建并维护术语表，确保所有人使用一致术语
  - 在代码、文档、会议中坚持使用领域术语
  - 将领域概念可视化展示
  - 建立持续反馈机制，及时解决歧义

### 2.6.4 分析一个业务领域的子域划分
- **面试问题**：如何为一个银行业务系统划分子域并确定优先级？
- **回答要点**：
  - 核心域：风险控制系统、交易引擎（竞争力所在）
  - 支撑域：客户关系管理、贷款审批流程
  - 通用域：人力资源、财务报表
  - 优先级确定因素：战略重要性、差异化价值、变更频率
- **分析过程**：
  1. 识别业务能力和流程
  2. 评估每个能力的战略重要性
  3. 分析行业通用性和差异化需求
  4. 考虑技术复杂度和资源约束 